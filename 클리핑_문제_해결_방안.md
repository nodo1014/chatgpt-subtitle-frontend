# 🚨 클리핑 정지/실패 문제 해결 방안

## 🔍 발견된 주요 문제점

### 1. **FFmpeg 명령어 순서 문제** (중요도: 🔥🔥🔥)
**현재**: `-ss` 옵션이 입력 파일 뒤에 위치 → 매우 느리고 부정확
**해결**: `-ss` 옵션을 입력 파일 앞으로 이동

### 2. **타임아웃 설정 부족** (중요도: 🔥🔥)
**현재**: 클립 60초, 썸네일 45초
**문제**: 대용량 파일 처리 시 부족

### 3. **동시 처리 과부하** (중요도: 🔥🔥)
**현재**: 배치 크기 2개씩 동시 처리
**문제**: 시스템 리소스 부족 (메모리 7.6GB/13GB 사용)

### 4. **파일 경로 공백 처리** (중요도: 🔥)
**문제**: 공백이 포함된 파일명 처리 오류 가능성

### 5. **에러 핸들링 부족** (중요도: 🔥)
**문제**: 특정 오류 상황에 대한 대응 부족

## 🛠️ 즉시 적용 가능한 해결책

### 1. FFmpeg 명령어 최적화
```typescript
// 수정 전 (느림)
const ffmpeg = spawn('ffmpeg', [
  '-i', mediaFile,
  '-ss', startSeconds.toString(),
  '-t', duration.toString(),
  ...options,
  outputPath
]);

// 수정 후 (빠름)
const ffmpeg = spawn('ffmpeg', [
  '-ss', startSeconds.toString(),    // 🔥 이걸 맨 앞으로!
  '-i', mediaFile,
  '-t', duration.toString(),
  '-c:v', 'libx264',               // 🔥 안정적인 코덱 사용
  '-c:a', 'aac',
  '-avoid_negative_ts', 'make_zero',
  '-y',
  outputPath
]);
```

### 2. 타임아웃 및 배치 크기 조정
```typescript
// config.ts 수정
BATCH_CONFIG: {
  THUMBNAIL_BATCH_SIZE: 1,         // 2 → 1 (안정성 우선)
  CLIP_BATCH_SIZE: 1,              // 2 → 1 (안정성 우선)
  CLIP_TIMEOUT: 180000,            // 60초 → 180초 (3분)
  THUMBNAIL_TIMEOUT: 90000         // 45초 → 90초 (1.5분)
}
```

### 3. 파일 경로 보호
```typescript
// 파일 경로에 따옴표 추가
const safeMediaFile = `"${mediaFile}"`; 
const safeOutputPath = `"${outputPath}"`;
```

### 4. 강화된 에러 감지
```typescript
// stderr에서 특정 에러 패턴 감지
if (chunk.includes('No such file') || 
    chunk.includes('Permission denied') ||
    chunk.includes('Invalid data') ||
    chunk.includes('Conversion failed')) {
  console.log(`🚨 치명적 오류 감지: ${chunk}`);
  ffmpeg.kill('SIGTERM');
  resolve(false);
}
```

### 5. 진행률 모니터링 개선
```typescript
// 무응답 감지 시간 늘리기
if (timeSinceLastProgress > 30000) {  // 15초 → 30초
  console.log(`⚠️ 진행 정지 감지 (${timeSinceLastProgress/1000}초 무응답)`);
  // 그러나 즉시 종료하지 않고 더 기다림
}

// 실제 종료는 더 오래 기다린 후
if (timeSinceLastProgress > 120000) {  // 2분 무응답 시 종료
  console.log(`🚨 프로세스 응답 없음 - 강제 종료`);
  ffmpeg.kill('SIGKILL');
  resolve(false);
}
```

### 6. 메모리 및 CPU 사용량 모니터링
```typescript
// 시스템 리소스 체크
const checkSystemResources = () => {
  const used = process.memoryUsage();
  const memUsedMB = Math.round(used.heapUsed / 1024 / 1024);
  
  if (memUsedMB > 1000) {  // 1GB 이상 사용 시 경고
    console.log(`⚠️ 메모리 사용량 높음: ${memUsedMB}MB`);
  }
};
```

## 🎯 우선순위별 적용 계획

### Phase 1: 즉시 수정 (5분)
1. **FFmpeg 명령어 순서 수정** - `-ss` 옵션 위치 변경
2. **배치 크기 1로 축소** - 안정성 우선

### Phase 2: 설정 최적화 (10분)
3. **타임아웃 시간 증가** - 3분으로 확대
4. **코덱 명시적 지정** - copy 대신 안정적 코덱

### Phase 3: 강화된 모니터링 (15분)
5. **에러 패턴 감지 추가**
6. **리소스 모니터링 구현**

## 💡 추가 권장사항

### 시스템 레벨 최적화
1. **FFmpeg 최신 버전 확인**
```bash
ffmpeg -version
```

2. **임시 파일 공간 확인**
```bash
df -h /tmp
```

3. **파일 시스템 권한 확인**
```bash
ls -la /mnt/qnap/media_eng/
```

### 로그 수집 강화
```typescript
// 실패한 파일들 로그 저장
const failedFiles = [];
if (!success) {
  failedFiles.push({
    file: mediaFile,
    error: stderr,
    timestamp: new Date().toISOString()
  });
}
```

이 수정사항들을 적용하면 **클리핑 성공률이 크게 향상**될 것입니다! 🚀
