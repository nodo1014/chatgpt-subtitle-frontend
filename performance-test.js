#!/usr/bin/env node\n\n/**\n * ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ë° ì‹¤íŒ¨ìœ¨ ë¶„ì„ ìŠ¤í¬ë¦½íŠ¸\n * \n * ì‚¬ìš©ë²•:\n * node performance-test.js\n * node performance-test.js --clips (í´ë¦½ ìƒì„± í¬í•¨)\n * node performance-test.js --analysis (ê¸°ì¡´ í´ë¦½ ë¶„ì„)\n */\n\nconst fetch = require('node-fetch');\nconst fs = require('fs').promises;\nconst path = require('path');\n\n// ì„¤ì •\nconst CONFIG = {\n  BASE_URL: 'http://localhost:3000',\n  CLIPS_DIR: './public/clips',\n  RESULTS_DIR: './test-results'\n};\n\n// ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ìš© ê²€ìƒ‰ì–´ (ë‹¤ì–‘í•œ ê²°ê³¼ ìˆ˜ ì˜ˆìƒ)\nconst PERFORMANCE_QUERIES = [\n  { query: \"hello\", expectedResults: \"ë§ìŒ\", difficulty: \"ì‰¬ì›€\" },\n  { query: \"thank you\", expectedResults: \"ë³´í†µ\", difficulty: \"ë³´í†µ\" },\n  { query: \"i'm sorry\", expectedResults: \"ë³´í†µ\", difficulty: \"ë³´í†µ\" },\n  { query: \"what did you\", expectedResults: \"ì ìŒ\", difficulty: \"ì–´ë ¤ì›€\" },\n  { query: \"how are you\", expectedResults: \"ì ìŒ\", difficulty: \"ì–´ë ¤ì›€\" }\n];\n\n// í¬íŠ¸ ìë™ ê°ì§€\nasync function detectPort() {\n  const ports = [3000, 3006, 3008, 3010];\n  \n  for (const port of ports) {\n    try {\n      const response = await fetch(`http://localhost:${port}`, { timeout: 2000 });\n      if (response.ok) {\n        console.log(`ğŸ” ê°œë°œ ì„œë²„ ê°ì§€: http://localhost:${port}`);\n        return port;\n      }\n    } catch (error) {\n      continue;\n    }\n  }\n  \n  throw new Error('ê°œë°œ ì„œë²„ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. npm run devë¥¼ ë¨¼ì € ì‹¤í–‰í•˜ì„¸ìš”.');\n}\n\n// ê²€ìƒ‰ í…ŒìŠ¤íŠ¸\nasync function testSearch(query, port) {\n  const startTime = Date.now();\n  \n  try {\n    const response = await fetch(`http://localhost:${port}/api/batch-search`, {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        text: query,\n        results_per_sentence: 5\n      }),\n      timeout: 10000\n    });\n    \n    if (!response.ok) {\n      throw new Error(`HTTP ${response.status}`);\n    }\n    \n    const data = await response.json();\n    const searchTime = Date.now() - startTime;\n    \n    return {\n      success: true,\n      query,\n      resultCount: data.search_summary?.total_results || 0,\n      searchTime,\n      data\n    };\n  } catch (error) {\n    return {\n      success: false,\n      query,\n      error: error.message,\n      searchTime: Date.now() - startTime\n    };\n  }\n}\n\n// í´ë¦½ ìƒì„± í…ŒìŠ¤íŠ¸\nasync function testClipCreation(searchData, port) {\n  const startTime = Date.now();\n  \n  try {\n    const response = await fetch(`http://localhost:${port}/api/auto-clips`, {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        sentence_results: searchData.sentence_results || []\n      }),\n      timeout: 300000 // 5ë¶„ íƒ€ì„ì•„ì›ƒ\n    });\n    \n    if (!response.ok) {\n      throw new Error(`HTTP ${response.status}`);\n    }\n    \n    const result = await response.json();\n    const clipTime = Date.now() - startTime;\n    \n    return {\n      success: true,\n      clipTime,\n      totalCreated: result.total_created || 0,\n      totalProcessed: result.total_processed || 0,\n      stats: result.stats\n    };\n  } catch (error) {\n    return {\n      success: false,\n      error: error.message,\n      clipTime: Date.now() - startTime\n    };\n  }\n}\n\n// ê¸°ì¡´ í´ë¦½ ë¶„ì„\nasync function analyzeExistingClips() {\n  try {\n    const clipsDir = CONFIG.CLIPS_DIR;\n    const files = await fs.readdir(clipsDir);\n    \n    const jsonFiles = files.filter(f => f.endsWith('.json'));\n    const mp4Files = files.filter(f => f.endsWith('.mp4'));\n    const jpgFiles = files.filter(f => f.endsWith('.jpg'));\n    \n    console.log('ğŸ“Š ê¸°ì¡´ í´ë¦½ ë¶„ì„ ê²°ê³¼:');\n    console.log(`   ğŸ“„ JSON íŒŒì¼: ${jsonFiles.length}ê°œ`);\n    console.log(`   ğŸ¬ MP4 íŒŒì¼: ${mp4Files.length}ê°œ`);\n    console.log(`   ğŸ–¼ï¸ JPG íŒŒì¼: ${jpgFiles.length}ê°œ`);\n    \n    // ìƒíƒœë³„ ë¶„ì„\n    const statusCount = {\n      'stage-1-json': 0,\n      'stage-2-thumbnail': 0,\n      'stage-3-complete': 0,\n      'stage-3-failed': 0,\n      'unknown': 0\n    };\n    \n    for (const jsonFile of jsonFiles) {\n      try {\n        const content = await fs.readFile(path.join(clipsDir, jsonFile), 'utf-8');\n        const metadata = JSON.parse(content);\n        \n        if (metadata.tags) {\n          if (metadata.tags.includes('stage-3-complete')) {\n            statusCount['stage-3-complete']++;\n          } else if (metadata.tags.includes('stage-3-failed')) {\n            statusCount['stage-3-failed']++;\n          } else if (metadata.tags.includes('stage-2-thumbnail')) {\n            statusCount['stage-2-thumbnail']++;\n          } else if (metadata.tags.includes('stage-1-json')) {\n            statusCount['stage-1-json']++;\n          } else {\n            statusCount['unknown']++;\n          }\n        } else {\n          statusCount['unknown']++;\n        }\n      } catch (error) {\n        statusCount['unknown']++;\n      }\n    }\n    \n    console.log('\\nğŸ·ï¸ ìƒíƒœë³„ ë¶„ì„:');\n    console.log(`   ğŸ”„ JSONë§Œ ìƒì„±: ${statusCount['stage-1-json']}ê°œ`);\n    console.log(`   ğŸ“¸ ì¸ë„¤ì¼ê¹Œì§€: ${statusCount['stage-2-thumbnail']}ê°œ`);\n    console.log(`   âœ… ì™„ì „ ì™„ë£Œ: ${statusCount['stage-3-complete']}ê°œ`);\n    console.log(`   âŒ ìƒì„± ì‹¤íŒ¨: ${statusCount['stage-3-failed']}ê°œ`);\n    console.log(`   â“ ìƒíƒœ ë¶ˆëª…: ${statusCount['unknown']}ê°œ`);\n    \n    const totalProcessed = Object.values(statusCount).reduce((a, b) => a + b, 0);\n    const successRate = totalProcessed > 0 ? (statusCount['stage-3-complete'] / totalProcessed * 100).toFixed(1) : 0;\n    \n    console.log(`\\nğŸ“ˆ ì„±ê³µë¥ : ${successRate}% (${statusCount['stage-3-complete']}/${totalProcessed})`);\n    \n    return {\n      totalFiles: {\n        json: jsonFiles.length,\n        mp4: mp4Files.length,\n        jpg: jpgFiles.length\n      },\n      statusCount,\n      successRate: parseFloat(successRate)\n    };\n  } catch (error) {\n    console.error('âŒ í´ë¦½ ë¶„ì„ ì‹¤íŒ¨:', error.message);\n    return null;\n  }\n}\n\n// ë©”ì¸ í…ŒìŠ¤íŠ¸ ì‹¤í–‰\nasync function runPerformanceTest() {\n  console.log('ğŸš€ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹œì‘');\n  console.log('=' .repeat(60));\n  \n  try {\n    // í¬íŠ¸ ê°ì§€\n    const port = await detectPort();\n    CONFIG.BASE_URL = `http://localhost:${port}`;\n    \n    // ê¸°ì¡´ í´ë¦½ ë¶„ì„\n    console.log('\\nğŸ“Š ê¸°ì¡´ í´ë¦½ ìƒíƒœ ë¶„ì„...');\n    const analysis = await analyzeExistingClips();\n    \n    // ê²€ìƒ‰ í…ŒìŠ¤íŠ¸\n    console.log('\\nğŸ” ê²€ìƒ‰ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸...');\n    const searchResults = [];\n    \n    for (let i = 0; i < PERFORMANCE_QUERIES.length; i++) {\n      const testCase = PERFORMANCE_QUERIES[i];\n      console.log(`\\n[${i + 1}/${PERFORMANCE_QUERIES.length}] \"${testCase.query}\" (${testCase.difficulty})`);\n      \n      const result = await testSearch(testCase.query, port);\n      searchResults.push({ ...result, ...testCase });\n      \n      if (result.success) {\n        console.log(`   âœ… ${result.resultCount}ê°œ ê²°ê³¼ (${result.searchTime}ms)`);\n      } else {\n        console.log(`   âŒ ì‹¤íŒ¨: ${result.error}`);\n      }\n    }\n    \n    // í´ë¦½ ìƒì„± í…ŒìŠ¤íŠ¸ (ì˜µì…˜)\n    const includeClips = process.argv.includes('--clips');\n    let clipResults = [];\n    \n    if (includeClips) {\n      console.log('\\nğŸ¬ í´ë¦½ ìƒì„± í…ŒìŠ¤íŠ¸...');\n      \n      for (const searchResult of searchResults) {\n        if (searchResult.success && searchResult.resultCount > 0) {\n          console.log(`\\ní´ë¦½ ìƒì„±: \"${searchResult.query}\"`);\n          const clipResult = await testClipCreation(searchResult.data, port);\n          clipResults.push({ query: searchResult.query, ...clipResult });\n          \n          if (clipResult.success) {\n            console.log(`   âœ… ${clipResult.totalCreated}ê°œ ìƒì„± (${(clipResult.clipTime/1000).toFixed(1)}ì´ˆ)`);\n          } else {\n            console.log(`   âŒ ì‹¤íŒ¨: ${clipResult.error}`);\n          }\n        }\n      }\n    }\n    \n    // ê²°ê³¼ ìš”ì•½\n    console.log('\\n' + '=' .repeat(60));\n    console.log('ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½');\n    console.log('=' .repeat(60));\n    \n    // ê²€ìƒ‰ ì„±ëŠ¥\n    const successfulSearches = searchResults.filter(r => r.success);\n    const avgSearchTime = successfulSearches.length > 0 \n      ? successfulSearches.reduce((sum, r) => sum + r.searchTime, 0) / successfulSearches.length \n      : 0;\n    const totalResults = successfulSearches.reduce((sum, r) => sum + r.resultCount, 0);\n    \n    console.log(`ğŸ” ê²€ìƒ‰ í…ŒìŠ¤íŠ¸:`);\n    console.log(`   ì„±ê³µ: ${successfulSearches.length}/${searchResults.length}`);\n    console.log(`   í‰ê·  ì‹œê°„: ${avgSearchTime.toFixed(0)}ms`);\n    console.log(`   ì´ ê²°ê³¼: ${totalResults}ê°œ`);\n    \n    // í´ë¦½ ìƒì„± ì„±ëŠ¥\n    if (clipResults.length > 0) {\n      const successfulClips = clipResults.filter(r => r.success);\n      const avgClipTime = successfulClips.length > 0\n        ? successfulClips.reduce((sum, r) => sum + r.clipTime, 0) / successfulClips.length\n        : 0;\n      const totalCreated = successfulClips.reduce((sum, r) => sum + r.totalCreated, 0);\n      \n      console.log(`\\nğŸ¬ í´ë¦½ ìƒì„±:`);\n      console.log(`   ì„±ê³µ: ${successfulClips.length}/${clipResults.length}`);\n      console.log(`   í‰ê·  ì‹œê°„: ${(avgClipTime/1000).toFixed(1)}ì´ˆ`);\n      console.log(`   ì´ ìƒì„±: ${totalCreated}ê°œ`);\n    }\n    \n    // ì „ì²´ ì‹œìŠ¤í…œ ìƒíƒœ\n    if (analysis) {\n      console.log(`\\nğŸ“ˆ ì‹œìŠ¤í…œ ìƒíƒœ:`);\n      console.log(`   ì „ì²´ ì„±ê³µë¥ : ${analysis.successRate}%`);\n      console.log(`   ì™„ë£Œëœ í´ë¦½: ${analysis.statusCount['stage-3-complete']}ê°œ`);\n      console.log(`   ì‹¤íŒ¨í•œ í´ë¦½: ${analysis.statusCount['stage-3-failed']}ê°œ`);\n    }\n    \n    // ê²°ê³¼ ì €ì¥\n    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');\n    const reportPath = path.join(CONFIG.RESULTS_DIR, `performance-${timestamp}.json`);\n    \n    await fs.mkdir(CONFIG.RESULTS_DIR, { recursive: true });\n    await fs.writeFile(reportPath, JSON.stringify({\n      timestamp: new Date().toISOString(),\n      searchResults,\n      clipResults,\n      analysis,\n      summary: {\n        searchSuccess: successfulSearches.length,\n        searchTotal: searchResults.length,\n        avgSearchTime,\n        totalResults,\n        clipSuccess: clipResults.filter(r => r.success).length,\n        clipTotal: clipResults.length,\n        avgClipTime: clipResults.length > 0 ? avgClipTime : 0\n      }\n    }, null, 2));\n    \n    console.log(`\\nğŸ’¾ ê²°ê³¼ ì €ì¥: ${reportPath}`);\n    \n  } catch (error) {\n    console.error('âŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error.message);\n    process.exit(1);\n  }\n}\n\n// ì‹¤í–‰\nif (process.argv.includes('--analysis')) {\n  analyzeExistingClips().then(() => process.exit(0));\n} else {\n  runPerformanceTest().then(() => process.exit(0));\n}" 