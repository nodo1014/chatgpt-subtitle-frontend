'use client';

import { useState, useEffect } from 'react';
import { useSearchParams, useRouter } from 'next/navigation';
import Image from 'next/image';

interface SearchResult {
  media_file: string;
  subtitle_text: string;
  start_time: string;
  end_time: string;
  language: string;
  directory: string;
  confidence: number;
}

interface SentenceResult {
  sentence_index: number;
  search_sentence: string;
  found_count: number;
  results: SearchResult[];
}

interface SearchData {
  success: boolean;
  extracted_sentences: string[];
  search_summary: {
    total_sentences: number;
    total_results: number;
    average_per_sentence: string;
    search_time: number;
  };
  sentence_results: SentenceResult[];
  auto_create_clips: boolean;
}

interface ClipMetadata {
  id: string;
  title: string;
  sentence: string;
  englishSubtitle: string;
  koreanSubtitle: string;
  startTime: string;
  endTime: string;
  sourceFile: string;
  clipPath: string;
  thumbnailPath?: string;
  createdAt: string;
  duration: string;
  tags: string[];
}

interface HistoryItem {
  title: string;
  count: number;
  timestamp: string;
}

'use client';

import { useResultsData, useClipOperations } from './hooks';
import { showToastMessage } from './utils';

// Components
import Sidebar from './components/Sidebar';
import Header from './components/Header';
import TabNavigation from './components/TabNavigation';
import AutoClipProgress from './components/AutoClipProgress';
import SearchResults from './components/SearchResults';
import ClipsView from './components/ClipsView';
import Toast from './components/Toast';

export default function ResultsPage() {
  const {
    // State
    searchData,
    loading,
    clippingStatus,
    setClippingStatus,
    clips,
    setClips,
    viewMode,
    setViewMode,
    sidebarCollapsed,
    setSidebarCollapsed,
    searchHistory,
    autoClipProgress,
    setAutoClipProgress,
    showToast,
    setShowToast,
    toastMessage,
    setToastMessage,
    // Functions
    loadClips,
    router
  } = useResultsData();

  const {
    createAutoClipsInBackground,
    createClip,
    deleteClip
  } = useClipOperations(
    setClippingStatus,
    setClips,
    setViewMode,
    setAutoClipProgress,
    setToastMessage,
    setShowToast,
    loadClips
  );

  useEffect(() => {
    if (process.env.NODE_ENV === 'development') {
      console.log('ğŸ” useEffect ì‹¤í–‰ë¨');
    }
    
    // ëª¨ë°”ì¼ì—ì„œëŠ” ì‚¬ì´ë“œë°” ê¸°ë³¸ ìˆ¨ê¹€
    if (typeof window !== 'undefined' && window.innerWidth <= 768) {
      setSidebarCollapsed(true);
    }

    // ê²€ìƒ‰ íˆìŠ¤í† ë¦¬ ë¡œë“œ
    loadSearchHistory();
    
    // URLì—ì„œ view íŒŒë¼ë¯¸í„° í™•ì¸
    const viewParam = searchParams.get('view');
    if (process.env.NODE_ENV === 'development') {
      console.log('ğŸ” viewParam:', viewParam);
    }
    
    if (viewParam === 'clips') {
      if (process.env.NODE_ENV === 'development') {
        console.log('ğŸ¬ í´ë¦½ ëª¨ë“œë¡œ ì „í™˜');
      }
      setViewMode('clips');
      loadClips();
      setLoading(false);
      return;
    }

    const dataParam = searchParams.get('data');
    if (dataParam) {
      try {
        const decodedData = JSON.parse(decodeURIComponent(dataParam));
        setSearchData(decodedData);
        loadClips();
        
        // ìë™ í´ë¦½ ìƒì„±ì´ í™œì„±í™”ëœ ê²½ìš°
        if (process.env.NODE_ENV === 'development') {
          console.log('ğŸ” ìë™ í´ë¦½ ìƒì„± í”Œë˜ê·¸ í™•ì¸:', decodedData.auto_create_clips);
        }
        if (decodedData.auto_create_clips) {
          console.log('âœ… ìë™ í´ë¦½ ìƒì„± ì‹œì‘ ì˜ˆì • (ì¦‰ì‹œ ë°±ê·¸ë¼ìš´ë“œ ì‹¤í–‰)');
          console.log('ğŸ“Š ê²€ìƒ‰ ê²°ê³¼ ë°ì´í„°:', decodedData.sentence_results);
          
          // ì‚¬ìš©ìì—ê²Œ í´ë¦½ ìƒì„± ì‹œì‘ì„ ì•Œë¦¼
          const totalExpected = decodedData.sentence_results.reduce((acc: number, sr: SentenceResult) => acc + Math.min(sr.results.length, 5), 0);
          console.log(`ğŸ“ˆ ì˜ˆìƒ í´ë¦½ ê°œìˆ˜: ${totalExpected}`);
          
          setAutoClipProgress({ 
            isCreating: true, 
            progress: 0, 
            total: totalExpected,
            current: `ğŸš€ ìë™ í´ë¦½ ìƒì„±ì´ ì‹œì‘ë©ë‹ˆë‹¤! (ì´ ${totalExpected}ê°œ ì˜ˆìƒ)` 
          });
          
          // ì¦‰ì‹œ í† ìŠ¤íŠ¸ ì•Œë¦¼ í‘œì‹œ
          showToastMessage(`ğŸ¬ ${totalExpected}ê°œì˜ í´ë¦½ ìƒì„±ì„ ì‹œì‘í•©ë‹ˆë‹¤!`);
          
          // ì¦‰ì‹œ ë°±ê·¸ë¼ìš´ë“œì—ì„œ í´ë¦½ ìƒì„± ì‹œì‘ (UI ë¸”ë¡œí‚¹ ì—†ìŒ)
          console.log('ğŸ¯ createAutoClipsInBackground í•¨ìˆ˜ í˜¸ì¶œ ì‹œì‘');
          createAutoClipsInBackground(decodedData);
        } else {
          if (process.env.NODE_ENV === 'development') {
            console.log('âŒ ìë™ í´ë¦½ ìƒì„±ì´ ë¹„í™œì„±í™”ë¨');
          }
        }
      } catch (error) {
        console.error('ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:', error);
        router.push('/');
      }
    } else {
      router.push('/');
    }
    setLoading(false);
  }, [searchParams, router]);

  // í´ë¦½ ëª©ë¡ ìë™ ìƒˆë¡œê³ ì¹¨ (3ë‹¨ê³„ ìƒíƒœ ë³€í™” ì‹¤ì‹œê°„ í™•ì¸)
  useEffect(() => {
    let intervalId: NodeJS.Timeout;
    
    if (viewMode === 'clips' || autoClipProgress.isCreating) {
      // 2ì´ˆë§ˆë‹¤ í´ë¦½ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
      intervalId = setInterval(() => {
        if (process.env.NODE_ENV === 'development') {
          console.log('ğŸ”„ í´ë¦½ ëª©ë¡ ìë™ ìƒˆë¡œê³ ì¹¨');
        }
        loadClips();
      }, 2000);
    }
    
    return () => {
      if (intervalId) {
        clearInterval(intervalId);
      }
    };
  }, [viewMode, autoClipProgress.isCreating]);

  const loadSearchHistory = () => {
    // ìƒ˜í”Œ íˆìŠ¤í† ë¦¬ ë°ì´í„°
    const sampleHistory: HistoryItem[] = [
      { title: 'ğŸ’• ì‚¬ë‘ê³¼ ê´€ê³„ í‘œí˜„', count: 15, timestamp: '2024-01-15' },
      { title: 'ğŸ’¼ ë¹„ì¦ˆë‹ˆìŠ¤ ë¯¸íŒ… ì˜ì–´', count: 12, timestamp: '2024-01-14' },
      { title: 'â˜• ì¼ìƒ ëŒ€í™” í‘œí˜„', count: 18, timestamp: '2024-01-13' },
      { title: 'ğŸ˜Š ê°ì • í‘œí˜„í•˜ê¸°', count: 20, timestamp: '2024-01-12' },
      { title: 'ğŸ• ìŒì‹ ê´€ë ¨ í‘œí˜„', count: 16, timestamp: '2024-01-11' },
      { title: 'âœˆï¸ ì—¬í–‰ ì˜ì–´ í‘œí˜„', count: 22, timestamp: '2024-01-10' },
      { title: 'ğŸ“ í•™êµìƒí™œ í‘œí˜„', count: 14, timestamp: '2024-01-09' },
      { title: 'ğŸ’ª ìš´ë™ê³¼ ê±´ê°•', count: 19, timestamp: '2024-01-08' },
      { title: 'ğŸ¬ ì˜í™” ë¦¬ë·° í‘œí˜„', count: 17, timestamp: '2024-01-07' },
      { title: 'ğŸ›ï¸ ì‡¼í•‘ ì˜ì–´', count: 13, timestamp: '2024-01-06' },
    ];
    setSearchHistory(sampleHistory);
  };

  const loadClips = async () => {
    try {
      if (process.env.NODE_ENV === 'development') {
        console.log('ğŸ¬ í´ë¦½ ëª©ë¡ ë¡œë“œ ì‹œì‘');
      }
      const response = await fetch('/api/clips');
      const data = await response.json();
      if (process.env.NODE_ENV === 'development') {
        console.log('ğŸ¬ í´ë¦½ ëª©ë¡ ì‘ë‹µ:', data);
      }
      
      if (data.success) {
        setClips(data.clips);
        if (process.env.NODE_ENV === 'development') {
          console.log('ğŸ¬ í´ë¦½ ëª©ë¡ ì„¤ì • ì™„ë£Œ, ê°œìˆ˜:', data.clips.length);
        }
      } else {
        console.error('í´ë¦½ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', data.error);
      }
    } catch (error) {
      console.error('í´ë¦½ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
    }
  };

  // ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰ë˜ëŠ” ë¹„ë™ê¸° í´ë¦½ ìƒì„±
  const createAutoClipsInBackground = async (data: SearchData) => {
    console.log('ğŸš€ ë°±ê·¸ë¼ìš´ë“œ í´ë¦½ ìƒì„± ì‹œì‘');
    console.log('ğŸ“¥ ë°›ì€ ë°ì´í„°:', data);
    
    const totalExpected = data.sentence_results.reduce((acc, sr) => acc + Math.min(sr.results.length, 5), 0);
    
    // ì¦‰ì‹œ ì§„í–‰ ìƒí™© UI í‘œì‹œ
    setAutoClipProgress({ 
      isCreating: true, 
      progress: 0, 
      total: totalExpected,
      current: `ğŸ¬ í´ë¦½ ìƒì„± ì¤€ë¹„ ì¤‘... (ì´ ${totalExpected}ê°œ ì˜ˆìƒ)` 
    });
    
    // ì‹¤ì‹œê°„ í´ë¦½ ëª©ë¡ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•œ ì¸í„°ë²Œ ì„¤ì •
    const clipRefreshInterval = setInterval(async () => {
      if (process.env.NODE_ENV === 'development') {
        console.log('ğŸ”„ í´ë¦½ ëª©ë¡ ì‹¤ì‹œê°„ ìƒˆë¡œê³ ì¹¨');
      }
      await loadClips();
    }, 2000); // 2ì´ˆë§ˆë‹¤ í´ë¦½ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
    
    // ë°±ê·¸ë¼ìš´ë“œì—ì„œ í´ë¦½ ìƒì„± (UI ë¸”ë¡œí‚¹ ì—†ìŒ)
    setTimeout(async () => {
      try {
        console.log('â° setTimeout ì‹¤í–‰ë¨ - API í˜¸ì¶œ ì‹œì‘');
        
        // ì§„í–‰ ìƒí™© ì‹œë®¬ë ˆì´ì…˜ (ì‹¤ì œ API í˜¸ì¶œ ì „)
        let simulatedProgress = 0;
        const progressInterval = setInterval(() => {
          if (simulatedProgress < totalExpected * 0.8) { // 80%ê¹Œì§€ë§Œ ì‹œë®¬ë ˆì´ì…˜
            simulatedProgress += Math.random() * 2;
            setAutoClipProgress(prev => ({ 
              ...prev,
              progress: Math.min(simulatedProgress, totalExpected * 0.8),
              current: `ğŸ¬ í´ë¦½ ìƒì„± ì¤‘... (${Math.round(simulatedProgress)}/${totalExpected})` 
            }));
          }
        }, 500);

        console.log('ğŸŒ API í˜¸ì¶œ ì‹œì‘: /api/auto-clips');
        console.log('ğŸ“¤ ì „ì†¡ ë°ì´í„°:', { sentence_results: data.sentence_results });
        
        const response = await fetch('/api/auto-clips', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ sentence_results: data.sentence_results })
        });
        
        console.log('ğŸ“¡ API ì‘ë‹µ ìƒíƒœ:', response.status, response.statusText);

        clearInterval(progressInterval); // ì‹œë®¬ë ˆì´ì…˜ ì¤‘ì§€
        clearInterval(clipRefreshInterval); // ì‹¤ì‹œê°„ ìƒˆë¡œê³ ì¹¨ ì¤‘ì§€

        const result = await response.json();
        if (process.env.NODE_ENV === 'development') {
          console.log('ğŸ¬ ë°±ê·¸ë¼ìš´ë“œ í´ë¦½ ìƒì„± ê²°ê³¼:', result);
        }
        
        if (result.success) {
          setAutoClipProgress({ 
            isCreating: false, 
            progress: result.total_created, 
            total: result.total_processed, 
            current: `âœ… ${result.total_created}ê°œ í´ë¦½ ìƒì„± ì™„ë£Œ! (${result.total_processed}ê°œ ì²˜ë¦¬ë¨)` 
          });
          
          // í† ìŠ¤íŠ¸ ì•Œë¦¼ í‘œì‹œ
          showToastMessage(`ğŸ‰ ${result.total_created}ê°œì˜ í´ë¦½ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!`);
          
          // í´ë¦½ ëª©ë¡ ìµœì¢… ë¡œë“œ
          await loadClips();
          
          // 3ì´ˆ í›„ í´ë¦½ íƒ­ìœ¼ë¡œ ìë™ ì „í™˜
          setTimeout(() => {
            setViewMode('clips');
            showToastMessage('ğŸ“º í´ë¦½ ë³´ê¸° íƒ­ìœ¼ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤!');
            if (process.env.NODE_ENV === 'development') {
              console.log('ğŸ¯ í´ë¦½ íƒ­ìœ¼ë¡œ ìë™ ì „í™˜');
            }
          }, 3000);
          
          // 8ì´ˆ í›„ ì§„í–‰ ìƒí™© ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
          setTimeout(() => {
            setAutoClipProgress({ isCreating: false, progress: 0, total: 0, current: '' });
          }, 8000);
        } else {
          console.error('ë°±ê·¸ë¼ìš´ë“œ í´ë¦½ ìƒì„± ì‹¤íŒ¨:', result.error);
          clearInterval(clipRefreshInterval); // ì‹¤ì‹œê°„ ìƒˆë¡œê³ ì¹¨ ì¤‘ì§€
          setAutoClipProgress({ 
            isCreating: false, 
            progress: 0, 
            total: 0, 
            current: 'âŒ í´ë¦½ ìƒì„± ì‹¤íŒ¨' 
          });
        }
      } catch (error) {
        console.error('ë°±ê·¸ë¼ìš´ë“œ í´ë¦½ ìƒì„± ì˜¤ë¥˜:', error);
        clearInterval(clipRefreshInterval); // ì‹¤ì‹œê°„ ìƒˆë¡œê³ ì¹¨ ì¤‘ì§€
        setAutoClipProgress({ 
          isCreating: false, 
          progress: 0, 
          total: 0, 
          current: 'âŒ í´ë¦½ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ' 
        });
      }
    }, 100); // 100ms í›„ ì‹œì‘ (UI ë Œë”ë§ ì™„ë£Œ í›„)
  };

  const createAutoClips = async (data: SearchData) => {
    setAutoClipProgress({ isCreating: true, progress: 0, total: 0, current: 'í´ë¦½ ìƒì„± ì¤€ë¹„ ì¤‘...' });
    
    try {
      if (process.env.NODE_ENV === 'development') {
        console.log('ğŸ¬ ìë™ í´ë¦½ ìƒì„± ì‹œì‘, ë°ì´í„°:', data);
      }
      
      const response = await fetch('/api/auto-clips', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ sentence_results: data.sentence_results }) // ì˜¬ë°”ë¥¸ êµ¬ì¡°ë¡œ ì „ë‹¬
      });

      const result = await response.json();
      if (process.env.NODE_ENV === 'development') {
        console.log('ğŸ¬ í´ë¦½ ìƒì„± ê²°ê³¼:', result);
      }
      
      if (result.success) {
        setAutoClipProgress({ 
          isCreating: false, 
          progress: result.total_created, 
          total: result.total_processed, 
          current: `${result.total_created}ê°œ í´ë¦½ ìƒì„± ì™„ë£Œ!` 
        });
        
        // í´ë¦½ì´ ìƒì„±ë˜ë©´ ëª©ë¡ì„ ë‹¤ì‹œ ë¡œë“œí•˜ê³  í´ë¦½ íƒ­ìœ¼ë¡œ ì „í™˜
        await loadClips();
        setTimeout(() => {
          setViewMode('clips');
          // 5ì´ˆ í›„ ì§„í–‰ ìƒí™© ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
          setTimeout(() => {
            setAutoClipProgress({ isCreating: false, progress: 0, total: 0, current: '' });
          }, 5000);
        }, 2000);
      } else {
        console.error('í´ë¦½ ìƒì„± ì‹¤íŒ¨:', result.error);
        setAutoClipProgress({ isCreating: false, progress: 0, total: 0, current: 'í´ë¦½ ìƒì„± ì‹¤íŒ¨' });
      }
    } catch (error) {
      console.error('ìë™ í´ë¦½ ìƒì„± ì˜¤ë¥˜:', error);
      setAutoClipProgress({ isCreating: false, progress: 0, total: 0, current: 'í´ë¦½ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ' });
    }
  };

  const createClip = async (sentence: string, result: SearchResult, sentenceIndex: number, resultIndex: number) => {
    const clipKey = `${sentenceIndex}-${resultIndex}`;
    
    if (clippingStatus[clipKey]) return;
    
    setClippingStatus(prev => ({ ...prev, [clipKey]: true }));
    
    try {
      const response = await fetch('/api/clips', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          sentence,
          subtitle_text: result.subtitle_text,
          media_file: result.media_file,
          start_time: result.start_time,
          end_time: result.end_time,
          korean_subtitle: `í•œê¸€ ë²ˆì—­: ${sentence}`
        })
      });

      const data = await response.json();
      
      if (data.success) {
        setClips(prev => [data.clip, ...prev]);
        setViewMode('clips');
      } else {
        console.error('í´ë¦½ ìƒì„± ì‹¤íŒ¨:', data.error);
      }
    } catch (error) {
      console.error('í´ë¦½ ìƒì„± ì˜¤ë¥˜:', error);
    } finally {
      setClippingStatus(prev => ({ ...prev, [clipKey]: false }));
    }
  };

  const deleteClip = async (clipId: string) => {
    if (!confirm('ì •ë§ë¡œ ì´ í´ë¦½ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    try {
      const response = await fetch(`/api/clips/${clipId}`, {
        method: 'DELETE'
      });
      
      if (response.ok) {
        setClips(prev => prev.filter(clip => clip.id !== clipId));
      } else {
        console.error('í´ë¦½ ì‚­ì œ ì‹¤íŒ¨');
      }
    } catch (error) {
      console.error('í´ë¦½ ì‚­ì œ ì˜¤ë¥˜:', error);
    }
  };

  const formatTime = (timeStr: string) => {
    // "00:01:23,456" í˜•ì‹ì„ "1:23" í˜•ì‹ìœ¼ë¡œ ë³€í™˜
    try {
      const parts = timeStr.split(':');
      const minutes = parseInt(parts[1]);
      const seconds = parseInt(parts[2].split(',')[0]);
      return `${minutes}:${seconds.toString().padStart(2, '0')}`;
    } catch {
      return timeStr;
    }
  };

  const getLanguageEmoji = (language: string) => {
    return language === 'ko' ? 'ğŸ‡°ğŸ‡·' : 'ğŸ‡ºğŸ‡¸';
  };

  const getConfidenceColor = (confidence: number) => {
    if (confidence >= 0.95) return 'text-green-600';
    if (confidence >= 0.8) return 'text-blue-600';
    if (confidence >= 0.7) return 'text-yellow-600';
    return 'text-red-600';
  };

  const getMatchType = (confidence: number) => {
    if (confidence >= 0.95) return 'ì™„ì „ì¼ì¹˜';
    if (confidence >= 0.8) return 'ì •í™•ë§¤ì¹˜';
    if (confidence >= 0.7) return 'ë¶€ë¶„ë§¤ì¹˜';
    return 'ìœ ì‚¬ë§¤ì¹˜';
  };

  const toggleSidebar = () => {
    setSidebarCollapsed(!sidebarCollapsed);
  };

  const showToastMessage = (message: string) => {
    setToastMessage(message);
    setShowToast(true);
    setTimeout(() => setShowToast(false), 4000);
  };

  // í´ë¦½ ì¹´ë“œ ì»´í¬ë„ŒíŠ¸
  const ClipCard = ({ clip }: { clip: ClipMetadata }) => {
    const [thumbnailError, setThumbnailError] = useState(false);
    
    // 3ë‹¨ê³„ ìƒíƒœ í™•ì¸
    const getStageInfo = () => {
      if (clip.tags.includes('stage-3-complete')) {
        return { stage: 3, status: 'ì¬ìƒ ê°€ëŠ¥', icon: 'âœ…', color: 'text-green-600', bgColor: 'bg-green-100' };
      } else if (clip.tags.includes('stage-3-failed')) {
        return { stage: 3, status: 'ìƒì„± ì‹¤íŒ¨', icon: 'âŒ', color: 'text-red-600', bgColor: 'bg-red-100' };
      } else if (clip.tags.includes('stage-2-thumbnail')) {
        return { stage: 2, status: 'ì˜ìƒ ìƒì„± ì¤‘', icon: 'ğŸ¬', color: 'text-blue-600', bgColor: 'bg-blue-100' };
      } else if (clip.tags.includes('stage-1-json')) {
        return { stage: 1, status: 'ì¸ë„¤ì¼ ìƒì„± ì¤‘', icon: 'ğŸ“¸', color: 'text-yellow-600', bgColor: 'bg-yellow-100' };
      } else {
        return { stage: 0, status: 'ìƒì„± ëŒ€ê¸°', icon: 'ğŸ”„', color: 'text-gray-600', bgColor: 'bg-gray-100' };
      }
    };
    
    const stageInfo = getStageInfo();
    const isPlayable = stageInfo.stage === 3 && !clip.tags.includes('stage-3-failed');
    
    return (
      <div className="bg-white rounded-lg shadow-md overflow-hidden border border-gray-200 hover:shadow-lg transition-shadow">
        {/* ì¸ë„¤ì¼ */}
        <div className="relative aspect-video bg-gray-900">
          {clip.thumbnailPath && !thumbnailError ? (
            <Image
              src={clip.thumbnailPath}
              alt={clip.title}
              fill
              className="object-cover"
              unoptimized
              onError={(e) => {
                if (process.env.NODE_ENV === 'development') {
                  console.error('ì¸ë„¤ì¼ ë¡œë“œ ì‹¤íŒ¨:', clip.thumbnailPath);
                }
                setThumbnailError(true);
              }}
              onLoad={() => {
                if (process.env.NODE_ENV === 'development') {
                  console.log('ì¸ë„¤ì¼ ë¡œë“œ ì„±ê³µ:', clip.thumbnailPath);
                }
              }}
            />
          ) : (
            <div className="flex items-center justify-center h-full bg-gradient-to-br from-gray-800 to-gray-900">
              <div className="text-center text-white">
                <div className="text-4xl mb-2">ğŸ¬</div>
                <div className="text-sm opacity-75">ì¸ë„¤ì¼ ì—†ìŒ</div>
              </div>
            </div>
          )}
          
          {/* ì¢Œì¸¡ ìƒë‹¨ - DB ì œëª© */}
          <div className="absolute top-2 left-2">
            <div className="bg-black bg-opacity-80 text-white px-2 py-1 rounded text-xs font-medium max-w-[120px] truncate">
              {clip.title}
            </div>
          </div>
          
          {/* ìš°ì¸¡ ìƒë‹¨ - 3ë‹¨ê³„ ìƒíƒœ í‘œì‹œ */}
          <div className="absolute top-2 right-2">
            <div className={`${stageInfo.bgColor} ${stageInfo.color} px-2 py-1 rounded text-xs font-medium flex items-center gap-1`}>
              <span>{stageInfo.icon}</span>
              <span>{stageInfo.status}</span>
            </div>
          </div>
          
          {/* ì¤‘ì•™ - ì˜ì–´ ìë§‰ (ìœ íŠœë¸Œ ì¸ë„¤ì¼ ìŠ¤íƒ€ì¼) */}
          <div className="absolute inset-0 flex items-center justify-center p-4">
            <div className="text-white text-center">
              <div 
                className="font-black leading-tight drop-shadow-lg"
                style={{
                  textShadow: '3px 3px 6px rgba(0,0,0,0.9), -2px -2px 4px rgba(0,0,0,0.9), 2px -2px 4px rgba(0,0,0,0.9), -2px 2px 4px rgba(0,0,0,0.9)',
                  fontSize: 'clamp(16px, 4vw, 24px)'
                }}
              >
                "{clip.englishSubtitle}"
              </div>
            </div>
          </div>
          
          {/* ì§„í–‰ ì¤‘ì¼ ë•Œ ë¡œë”© ì˜¤ë²„ë ˆì´ */}
          {!isPlayable && stageInfo.stage > 0 && (
            <div className="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center">
              <div className="text-center text-white">
                <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-white mx-auto mb-2"></div>
                <div className="text-sm font-medium">{stageInfo.status}</div>
              </div>
            </div>
          )}
        </div>
        
        {/* ì œëª©ê³¼ ë²„íŠ¼ */}
        <div className="p-3">
          <h3 className="font-medium text-gray-800 mb-3 text-sm leading-tight truncate">
            {clip.title}
          </h3>
          
          {/* ì•¡ì…˜ ë²„íŠ¼ë“¤ */}
          <div className="flex gap-2">
            <button 
              onClick={() => isPlayable ? window.open(clip.clipPath, '_blank') : null}
              disabled={!isPlayable}
              className={`flex-1 px-3 py-2 rounded text-xs transition-colors flex items-center justify-center gap-1 ${
                isPlayable 
                  ? 'bg-blue-600 hover:bg-blue-700 text-white cursor-pointer' 
                  : 'bg-gray-300 text-gray-500 cursor-not-allowed'
              }`}
            >
              {isPlayable ? 'â–¶ï¸ ì¬ìƒ' : `${stageInfo.icon} ${stageInfo.status}`}
            </button>
            <button 
              onClick={async () => {
                try {
                  if (navigator.clipboard && window.isSecureContext) {
                    await navigator.clipboard.writeText(clip.englishSubtitle);
                  } else {
                    // Fallback for non-HTTPS environments
                    const textArea = document.createElement('textarea');
                    textArea.value = clip.englishSubtitle;
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-999999px';
                    textArea.style.top = '-999999px';
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    document.execCommand('copy');
                    textArea.remove();
                  }
                  // ì„±ê³µ í”¼ë“œë°± (ì„ íƒì‚¬í•­)
                  if (process.env.NODE_ENV === 'development') {
                    console.log('ìë§‰ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤:', clip.englishSubtitle);
                  }
                } catch (err) {
                  console.warn('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', err);
                  // ì‚¬ìš©ìì—ê²Œ ìˆ˜ë™ ë³µì‚¬ ì•ˆë‚´ (ì„ íƒì‚¬í•­)
                  alert(`í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ í…ìŠ¤íŠ¸ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ë³µì‚¬í•´ì£¼ì„¸ìš”:\n\n${clip.englishSubtitle}`);
                }
              }}
              className="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded text-xs transition-colors"
              title="ìë§‰ ë¶ë§ˆí¬"
            >
              ğŸ”–
            </button>
            <button 
              onClick={() => deleteClip(clip.id)}
              className="bg-red-100 hover:bg-red-200 text-red-700 px-3 py-2 rounded text-xs transition-colors"
              title="í´ë¦½ ì‚­ì œ"
            >
              ğŸ—‘ï¸
            </button>
          </div>
        </div>
      </div>
    );
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-white flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
          <p className="text-gray-600">ê²€ìƒ‰ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="flex h-screen overflow-hidden bg-[#0f0f23] transition-all duration-300 relative">
      {/* ChatGPT Style Sidebar */}
      <div className={`${sidebarCollapsed ? 'w-0 overflow-hidden' : 'w-64'} bg-[#171717] text-[#ececf1] flex flex-col border-r border-[#2d2d2d] transition-all duration-300 z-50`}>
        <div className="p-4 border-b border-[#2d2d2d] flex justify-between items-center">
          <button 
            onClick={() => router.push('/')}
            className="flex-1 bg-transparent border border-[#2d2d2d] text-[#ececf1] p-3 rounded-lg cursor-pointer transition-all duration-200 flex items-center gap-2 text-sm mr-2 hover:bg-[#2d2d2d]"
          >
            <span>â•</span>
            <span>ìƒˆ í…Œë§ˆ ê²€ìƒ‰</span>
          </button>
        </div>
        
        <div className="flex-1 p-4 overflow-y-auto max-h-[calc(100vh-80px)]">
          <div className="mb-6">
            <h3 className="text-xs text-[#8e8ea0] uppercase tracking-wide mb-3 font-semibold">ìµœê·¼ ê²€ìƒ‰</h3>
            {searchHistory.map((item, index) => (
              <div key={index} className="p-2.5 rounded-lg cursor-pointer transition-all duration-200 mb-0.5 text-sm leading-tight text-[#e5e5e5] hover:bg-[#2d2d2d]">
                {item.title} ({item.count}ê°œ ë¬¸ì¥)
              </div>
            ))}
          </div>
          
          <div className="mb-6">
            <h3 className="text-xs text-[#8e8ea0] uppercase tracking-wide mb-3 font-semibold">ì¦ê²¨ì°¾ê¸°</h3>
            <div className="p-2.5 rounded-lg cursor-pointer transition-all duration-200 mb-0.5 text-sm leading-tight text-[#e5e5e5] hover:bg-[#2d2d2d]">
              â­ TOEIC í•„ìˆ˜ í‘œí˜„
            </div>
            <div className="p-2.5 rounded-lg cursor-pointer transition-all duration-200 mb-0.5 text-sm leading-tight text-[#e5e5e5] hover:bg-[#2d2d2d]">
              â­ ë©´ì ‘ ì˜ì–´ í‘œí˜„
            </div>
            <div className="p-2.5 rounded-lg cursor-pointer transition-all duration-200 mb-0.5 text-sm leading-tight text-[#e5e5e5] hover:bg-[#2d2d2d]">
              â­ ì¹œêµ¬ì™€ì˜ ëŒ€í™”
            </div>
          </div>
        </div>
      </div>

      {/* Main Content */}
      <div className="flex-1 flex flex-col bg-white overflow-hidden transition-all duration-300">
        {/* Header */}
        <div className="bg-white border-b border-gray-200 p-3 flex items-center justify-between min-h-[60px]">
          <div className="flex items-center gap-3">
            <button 
              onClick={toggleSidebar}
              className="bg-transparent border border-gray-200 text-gray-700 p-2 rounded-md cursor-pointer transition-all duration-200 flex items-center justify-center w-9 h-9 hover:bg-gray-50"
            >
              <span>â˜°</span>
            </button>
            <div className="text-lg font-semibold text-gray-700 flex items-center gap-2">
              ğŸ¯ {viewMode === 'clips' ? 'í´ë¦½ ë³´ê¸°' : 'ê²€ìƒ‰ ê²°ê³¼'}
              {searchData && (
                <span className="text-sm text-gray-500">
                  {searchData.search_summary.total_sentences}ê°œ ë¬¸ì¥, ì´ {searchData.search_summary.total_results}ê°œ ê²°ê³¼
                </span>
              )}
            </div>
          </div>
          <div className="flex gap-3 text-sm text-gray-500">
            {searchData && (
              <div className="bg-gray-100 px-2 py-1 rounded-xl flex items-center gap-1 text-gray-700">
                <span>â±ï¸</span>
                <span>{searchData.search_summary.search_time}ì´ˆ</span>
              </div>
            )}
            <button 
              onClick={() => router.push('/results?view=clips')}
              className="bg-blue-100 hover:bg-blue-200 px-3 py-2 rounded-xl flex items-center gap-1 text-blue-700 transition-colors cursor-pointer"
            >
              <span>ğŸ¬</span>
              <span>í´ë¦½ ë³´ê¸°</span>
            </button>
          </div>
        </div>

        {/* Tab Navigation */}
        <div className="bg-gray-50 border-b border-gray-200 px-6">
          <div className="flex">
            <button
              onClick={() => setViewMode('search')}
              className={`px-4 py-3 text-sm font-medium border-b-2 transition-colors ${
                viewMode === 'search'
                  ? 'border-blue-500 text-blue-600'
                  : 'border-transparent text-gray-500 hover:text-gray-700'
              } ${!searchData ? 'opacity-50 cursor-not-allowed' : ''}`}
              disabled={!searchData}
            >
              ğŸ” ê²€ìƒ‰ ê²°ê³¼ {searchData ? `(${searchData.search_summary.total_results})` : ''}
            </button>
            <button
              onClick={() => setViewMode('clips')}
              className={`px-4 py-3 text-sm font-medium border-b-2 transition-colors ${
                viewMode === 'clips'
                  ? 'border-blue-500 text-blue-600'
                  : 'border-transparent text-gray-500 hover:text-gray-700'
              }`}
            >
              ğŸ¬ í´ë¦½ ({clips.length})
            </button>
          </div>
          {/* ë””ë²„ê·¸ ì •ë³´ */}
          {process.env.NODE_ENV === 'development' && (
            <div className="text-xs text-gray-500 p-2">
              DEBUG: viewMode={viewMode}, hasSearchData={!!searchData}, clipsCount={clips.length}
            </div>
          )}
        </div>

        {/* Auto Clip Progress - Enhanced */}
        {(autoClipProgress.isCreating || autoClipProgress.current) && (
          <div className="bg-gradient-to-r from-blue-50 via-indigo-50 to-purple-50 border-b border-blue-200 px-6 py-5 shadow-sm">
            <div className="max-w-4xl mx-auto">
              <div className="flex items-center justify-between mb-3">
                <div className="flex items-center gap-4">
                  {autoClipProgress.isCreating ? (
                    <div className="flex items-center gap-3">
                      <div className="relative">
                        <div className="animate-spin rounded-full h-8 w-8 border-3 border-blue-200 border-t-blue-600"></div>
                        <div className="absolute inset-0 flex items-center justify-center">
                          <div className="w-3 h-3 bg-blue-600 rounded-full animate-pulse"></div>
                        </div>
                      </div>
                      <div className="flex space-x-1">
                        <div className="w-2 h-2 bg-blue-600 rounded-full animate-bounce"></div>
                        <div className="w-2 h-2 bg-indigo-600 rounded-full animate-bounce" style={{animationDelay: '0.1s'}}></div>
                        <div className="w-2 h-2 bg-purple-600 rounded-full animate-bounce" style={{animationDelay: '0.2s'}}></div>
                      </div>
                    </div>
                  ) : (
                    <div className="flex items-center gap-2">
                      <span className="text-green-600 text-2xl">âœ…</span>
                      <div className="w-2 h-2 bg-green-500 rounded-full animate-ping"></div>
                    </div>
                  )}
                  <div className="flex flex-col">
                    <span className="text-base font-semibold text-blue-900">
                      {autoClipProgress.current}
                    </span>
                    {autoClipProgress.total > 0 && (
                      <span className="text-sm text-blue-700">
                        {Math.round(autoClipProgress.progress)}/{autoClipProgress.total} í´ë¦½ 
                        {autoClipProgress.isCreating ? 'ìƒì„± ì¤‘' : 'ì™„ë£Œ'}
                        {autoClipProgress.isCreating && (
                          <span className="ml-2 text-xs text-blue-600">
                            â€¢ ì˜ˆìƒ ì‹œê°„: {Math.max(1, Math.round((autoClipProgress.total - autoClipProgress.progress) * 0.5))}ë¶„
                          </span>
                        )}
                      </span>
                    )}
                  </div>
                </div>
                {autoClipProgress.total > 0 && (
                  <div className="flex items-center gap-4">
                    <div className="text-right">
                      <div className="text-lg font-bold text-blue-800">
                        {Math.round((autoClipProgress.progress / autoClipProgress.total) * 100)}%
                      </div>
                      <div className="text-xs text-blue-600">
                        {Math.round(autoClipProgress.progress)}/{autoClipProgress.total}
                      </div>
                    </div>
                  </div>
                )}
              </div>
              
              {autoClipProgress.total > 0 && (
                <div className="w-full bg-blue-200 rounded-full h-4 overflow-hidden shadow-inner">
                  <div 
                    className="bg-gradient-to-r from-blue-500 via-indigo-500 to-purple-500 h-full rounded-full transition-all duration-700 ease-out relative"
                    style={{ width: `${Math.min((autoClipProgress.progress / autoClipProgress.total) * 100, 100)}%` }}
                  >
                    {autoClipProgress.isCreating && (
                      <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white to-transparent opacity-30 animate-pulse"></div>
                    )}
                  </div>
                </div>
              )}
              
              {autoClipProgress.isCreating && (
                <div className="mt-3 text-center">
                  <p className="text-sm text-blue-700">
                    ğŸ¬ ë¯¸ë””ì–´ íŒŒì¼ì—ì„œ í´ë¦½ì„ ì¶”ì¶œí•˜ê³  ìˆìŠµë‹ˆë‹¤... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”!
                  </p>
                </div>
              )}
            </div>
          </div>
        )}

        {/* Content Area */}
        <div className="flex-1 overflow-y-auto p-6">
          {viewMode === 'search' && searchData ? (
            <div className="max-w-6xl mx-auto">
              {/* Search Summary */}
              <div className="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6 mb-8 border border-blue-100">
                <h3 className="text-lg font-bold mb-4 text-center text-gray-800">ğŸ“Š ê²€ìƒ‰ ìš”ì•½</h3>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                  <div className="bg-white rounded-lg p-4 text-center border border-blue-100">
                    <div className="text-2xl font-bold text-blue-600">{searchData.search_summary.total_sentences}</div>
                    <div className="text-sm text-gray-600">ê²€ìƒ‰ëœ ë¬¸ì¥</div>
                  </div>
                  <div className="bg-white rounded-lg p-4 text-center border border-blue-100">
                    <div className="text-2xl font-bold text-green-600">{searchData.search_summary.total_results}</div>
                    <div className="text-sm text-gray-600">ì´ ê²°ê³¼</div>
                  </div>
                  <div className="bg-white rounded-lg p-4 text-center border border-blue-100">
                    <div className="text-2xl font-bold text-purple-600">{searchData.search_summary.average_per_sentence}</div>
                    <div className="text-sm text-gray-600">í‰ê· /ë¬¸ì¥</div>
                  </div>
                  <div className="bg-white rounded-lg p-4 text-center border border-blue-100">
                    <div className="text-2xl font-bold text-orange-600">{searchData.search_summary.search_time}s</div>
                    <div className="text-sm text-gray-600">ê²€ìƒ‰ ì‹œê°„</div>
                  </div>
                </div>
              </div>

              {/* Results */}
              <div className="space-y-8">
                {searchData.sentence_results.map((sentenceResult) => (
                  <div key={sentenceResult.sentence_index} className="bg-white rounded-xl p-6 border border-gray-200 shadow-sm">
                    <div className="flex justify-between items-center mb-4 pb-3 border-b border-gray-100">
                      <h4 className="text-lg font-semibold text-gray-800 flex-1 mr-4">
                        {sentenceResult.sentence_index}. "{sentenceResult.search_sentence}"
                      </h4>
                      <div className="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-semibold">
                        {sentenceResult.found_count}ê°œ ê²°ê³¼
                      </div>
                    </div>

                    {sentenceResult.results.length > 0 ? (
                      <div className="grid gap-4">
                        {sentenceResult.results.map((result, index) => (
                          <div key={index} className="bg-gray-50 rounded-lg p-4 border border-gray-100 hover:bg-gray-100 transition-colors">
                            <div className="flex justify-between items-center mb-3 text-sm">
                              <div className="flex items-center gap-3">
                                <span className="font-semibold text-gray-800">{result.media_file}</span>
                                <span className="bg-gray-200 px-2 py-1 rounded text-xs text-gray-600">
                                  {result.directory}
                                </span>
                              </div>
                              <div className="flex items-center gap-3 text-gray-500">
                                <span className="font-mono">{formatTime(result.start_time)}</span>
                                <span className={`font-semibold ${getConfidenceColor(result.confidence)}`}>
                                  {getMatchType(result.confidence)}
                                </span>
                                <span className={`text-xs ${getConfidenceColor(result.confidence)}`}>
                                  {(result.confidence * 100).toFixed(0)}%
                                </span>
                                <span>{getLanguageEmoji(result.language)}</span>
                              </div>
                            </div>
                            
                            <div className="mb-3">
                              <p className="text-gray-800 italic leading-relaxed">
                                "{result.subtitle_text}"
                              </p>
                            </div>
                            
                            <div className="flex gap-2">
                              <button className="bg-green-100 hover:bg-green-200 text-green-800 px-3 py-1 rounded text-sm transition-colors">
                                ğŸ¬ ì¬ìƒ
                              </button>
                              <button 
                                onClick={() => createClip(sentenceResult.search_sentence, result, sentenceResult.sentence_index, index)}
                                disabled={clippingStatus[`${sentenceResult.sentence_index}-${index}`]}
                                className="bg-yellow-100 hover:bg-yellow-200 text-yellow-800 px-3 py-1 rounded text-sm transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                              >
                                {clippingStatus[`${sentenceResult.sentence_index}-${index}`] ? 'ğŸ¬ í´ë¦½ ìƒì„± ì¤‘...' : 'ğŸ“ í´ë¦½ ìƒì„±'}
                              </button>
                              <button className="bg-blue-100 hover:bg-blue-200 text-blue-800 px-3 py-1 rounded text-sm transition-colors">
                                ğŸ’¾ ì €ì¥
                              </button>
                            </div>
                          </div>
                        ))}
                      </div>
                    ) : (
                      <div className="text-center py-8 text-gray-500">
                        <div className="text-4xl mb-2">ğŸ”</div>
                        <p>ì´ ë¬¸ì¥ì— ëŒ€í•œ ê²°ê³¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                      </div>
                    )}
                  </div>
                ))}
              </div>
            </div>
          ) : viewMode === 'clips' ? (
            <div className="max-w-6xl mx-auto">
              <div className="mb-6">
                <h2 className="text-2xl font-bold text-gray-800 mb-2">ğŸ¬ ìƒì„±ëœ í´ë¦½</h2>
                <p className="text-gray-600">ì´ {clips.length}ê°œì˜ í´ë¦½ì´ ìˆìŠµë‹ˆë‹¤.</p>
                {/* ë””ë²„ê·¸ ì •ë³´ ì¶”ê°€ */}
                {process.env.NODE_ENV === 'development' && (
                  <div className="mt-2 p-2 bg-yellow-50 border border-yellow-200 rounded text-xs">
                    <strong>ë””ë²„ê·¸:</strong> clips ë°°ì—´ ê¸¸ì´: {clips.length}
                    {clips.length > 0 && (
                      <div>ì²« ë²ˆì§¸ í´ë¦½: {JSON.stringify(clips[0], null, 2)}</div>
                    )}
                  </div>
                )}
              </div>
              
              {clips.length > 0 ? (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                  {clips.map((clip) => (
                    <ClipCard key={clip.id} clip={clip} />
                  ))}
                </div>
              ) : (
                <div className="text-center py-16">
                  <div className="text-6xl mb-4">ğŸ¬</div>
                  <h3 className="text-xl font-semibold text-gray-800 mb-2">ì•„ì§ ìƒì„±ëœ í´ë¦½ì´ ì—†ìŠµë‹ˆë‹¤</h3>
                  <p className="text-gray-600 mb-6">ê²€ìƒ‰ ê²°ê³¼ì—ì„œ í´ë¦½ì„ ìƒì„±í•´ë³´ì„¸ìš”.</p>
                  {searchData && (
                    <button
                      onClick={() => setViewMode('search')}
                      className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg transition-colors"
                    >
                      ê²€ìƒ‰ ê²°ê³¼ë¡œ ì´ë™
                    </button>
                  )}
                </div>
              )}
            </div>
          ) : (
            <div className="max-w-6xl mx-auto text-center py-16">
              <div className="text-6xl mb-4">ğŸ”</div>
              <h3 className="text-xl font-semibold text-gray-800 mb-2">ê²€ìƒ‰ ê²°ê³¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h3>
              <p className="text-gray-600 mb-6">ìƒˆë¡œìš´ ê²€ìƒ‰ì„ ì‹œì‘í•´ë³´ì„¸ìš”.</p>
              <button 
                onClick={() => router.push('/')}
                className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg transition-colors"
              >
                ìƒˆ ê²€ìƒ‰ ì‹œì‘
              </button>
            </div>
          )}
        </div>
      </div>

      {/* Toast Notification */}
      {showToast && (
        <div className="fixed top-4 right-4 z-50 animate-slide-in-right">
          <div className="bg-gradient-to-r from-green-500 to-blue-500 text-white px-6 py-4 rounded-lg shadow-lg border border-white/20 backdrop-blur-sm">
            <div className="flex items-center gap-3">
              <div className="w-2 h-2 bg-white rounded-full animate-ping"></div>
              <span className="font-medium">{toastMessage}</span>
              <button 
                onClick={() => setShowToast(false)}
                className="ml-2 text-white/80 hover:text-white transition-colors"
              >
                âœ•
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}